# MLC-LLM Compilation Environment for OrbPro OrbPro2 MCP
# This Dockerfile is static - don't regenerate it to preserve layer caching
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

# Install dependencies
RUN apt-get update && apt-get install -y \
    python3 python3-pip python3-venv \
    git git-lfs cmake ninja-build \
    curl wget \
    && rm -rf /var/lib/apt/lists/*

# Install Emscripten
RUN git clone https://github.com/emscripten-core/emsdk.git /opt/emsdk && \
    cd /opt/emsdk && \
    ./emsdk install latest && \
    ./emsdk activate latest

# Set up Emscripten config and PATH in one step to capture node version
RUN cd /opt/emsdk && \
    . ./emsdk_env.sh && \
    echo "EMSDK = '/opt/emsdk'" > /root/.emscripten && \
    echo "NODE_JS = '$(which node)'" >> /root/.emscripten && \
    echo "LLVM_ROOT = '/opt/emsdk/upstream/bin'" >> /root/.emscripten && \
    echo "BINARYEN_ROOT = '/opt/emsdk/upstream'" >> /root/.emscripten && \
    echo "EMSCRIPTEN_ROOT = '/opt/emsdk/upstream/emscripten'" >> /root/.emscripten && \
    cat /root/.emscripten && \
    emcc --version

# Set PATH permanently (node is in /opt/emsdk/node/*/bin)
ENV PATH="/opt/emsdk/node/22.16.0_64bit/bin:/opt/emsdk:/opt/emsdk/upstream/emscripten:/opt/emsdk/upstream/bin:${PATH}"
ENV EMSDK="/opt/emsdk"
ENV EM_CONFIG="/root/.emscripten"

# Install MLC-LLM nightly wheels for CPU (x86_64)
RUN pip3 install --upgrade pip && \
    pip3 install --pre -U -f https://mlc.ai/wheels mlc-llm-nightly-cpu mlc-ai-nightly-cpu && \
    python3 -c "import mlc_llm; print('MLC-LLM installed successfully')"

# Install other dependencies
RUN pip3 install transformers safetensors sentencepiece huggingface_hub

# Clone MLC-LLM source (needed for WASM runtime)
RUN git clone --recursive https://github.com/mlc-ai/mlc-llm.git /opt/mlc-llm

# Build WASM runtime
RUN cd /opt/mlc-llm && \
    ./web/prep_emcc_deps.sh && \
    ls -la /opt/mlc-llm/web/dist/wasm/

# Set MLC_LLM_SOURCE_DIR so compile can find mlc_wasm_runtime.bc
ENV MLC_LLM_SOURCE_DIR="/opt/mlc-llm"

# Verify the WASM runtime exists
RUN test -f /opt/mlc-llm/web/dist/wasm/mlc_wasm_runtime.bc || \
    (echo "ERROR: mlc_wasm_runtime.bc not found!" && exit 1)

# Create cache directories for mounted volumes
RUN mkdir -p /root/.cache/huggingface /root/.cache/pip

WORKDIR /workspace

# Default command shows environment info
CMD ["bash", "-c", "echo MLC_LLM_SOURCE_DIR=$MLC_LLM_SOURCE_DIR && ls -la $MLC_LLM_SOURCE_DIR/web/dist/wasm/"]
